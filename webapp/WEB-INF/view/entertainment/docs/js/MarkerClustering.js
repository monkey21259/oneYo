var MarkerClustering=function(t){this.DEFAULT_OPTIONS={map:null,markers:[],disableClickZoom:!0,minClusterSize:2,maxZoom:13,gridSize:100,icons:[],indexGenerator:[10,100,200,500,1e3],stylingFunction:function(){}},this._clusters=[],this._mapRelations=null,this._markerRelations=[],this.setOptions(naver.maps.Util.extend({},this.DEFAULT_OPTIONS,t),!0),this.setMap(t.map||null)};naver.maps.Util.ClassExtend(MarkerClustering,naver.maps.OverlayView,{onAdd:function(){var t=this.getMap();this._mapRelations=naver.maps.Event.addListener(t,"idle",naver.maps.Util.bind(this._onIdle,this)),this.getMarkers().length>0&&(this._createClusters(),this._updateClusters())},draw:naver.maps.Util.noop,onRemove:function(){naver.maps.Event.removeListener(this._mapRelation),this._clearClusters(),this._geoTree=null,this._mapRelation=null},setOptions:function(t){var e=this;if("string"==typeof t){var s=t,r=arguments[1];e.set(s,r)}else{var n=arguments[1];naver.maps.Util.forEach(t,function(t,s){"map"!==s&&e.set(s,t)}),t.map&&!n&&e.setMap(t.map)}},getOptions:function(t){var e=this,s={};return void 0!==t?e.get(t):(naver.maps.Util.forEach(e.DEFAULT_OPTIONS,function(t,r){s[r]=e.get(r)}),s)},getMinClusterSize:function(){return this.getOptions("minClusterSize")},setMinClusterSize:function(t){this.setOptions("minClusterSize",t)},getMaxZoom:function(){return this.getOptions("maxZoom")},setMaxZoom:function(t){this.setOptions("maxZoom",t)},getGridSize:function(){return this.getOptions("gridSize")},setGridSize:function(t){this.setOptions("gridSize",t)},getIndexGenerator:function(){return this.getOptions("indexGenerator")},setIndexGenerator:function(t){this.setOptions("indexGenerator",t)},getMarkers:function(){return this.getOptions("markers")},setMarkers:function(t){this.setOptions("markers",t)},getIcons:function(){return this.getOptions("icons")},setIcons:function(t){this.setOptions("icons",t)},getStylingFunction:function(){return this.getOptions("stylingFunction")},setStylingFunction:function(t){this.setOptions("stylingFunction",t)},getDisableClickZoom:function(){return this.getOptions("disableClickZoom")},setDisableClickZoom:function(t){this.setOptions("disableClickZoom",t)},changed:function(t,e){if(this.getMap())switch(t){case"marker":case"minClusterSize":case"gridSize":this._redraw();break;case"indexGenerator":case"icons":this._clusters.forEach(function(t){t.updateIcon()});break;case"maxZoom":this._clusters.forEach(function(t){t.getCount()>1&&t.checkByZoomAndMinClusterSize()});break;case"stylingFunction":this._clusters.forEach(function(t){t.updateCount()});break;case"disableClickZoom":var s="enableClickZoom";e&&(s="disableClickZoom"),this._clusters.forEach(function(t){t[s]()})}},_createClusters:function(){var t=this.getMap();if(t)for(var e=t.getBounds(),s=this.getMarkers(),r=0,n=s.length;r<n;r++){var i=s[r],o=i.getPosition();if(e.hasLatLng(o))this._getClosestCluster(o).addMarker(i),this._markerRelations.push(naver.maps.Event.addListener(i,"dragend",naver.maps.Util.bind(this._onDragEnd,this)))}},_updateClusters:function(){for(var t=this._clusters,e=0,s=t.length;e<s;e++)t[e].updateCluster()},_clearClusters:function(){for(var t=this._clusters,e=0,s=t.length;e<s;e++)t[e].destroy();naver.maps.Event.removeListener(this._markerRelations),this._markerRelations=[],this._clusters=[]},_redraw:function(){this._clearClusters(),this._createClusters(),this._updateClusters()},_getClosestCluster:function(t){for(var e=this.getProjection(),s=this._clusters,r=null,n=1/0,i=0,o=s.length;i<o;i++){var a=s[i],u=a.getCenter();if(a.isInBounds(t)){var l=e.getDistance(u,t);l<n&&(n=l,r=a)}}return r||(r=new Cluster(this),this._clusters.push(r)),r},_onIdle:function(){this._redraw()},_onDragEnd:function(){this._redraw()}});var Cluster=function(t){this._clusterCenter=null,this._clusterBounds=null,this._clusterMarker=null,this._relation=null,this._clusterMember=[],this._markerClusterer=t};Cluster.prototype={constructor:Cluster,addMarker:function(t){if(!this._isMember(t)){if(!this._clusterCenter){var e=t.getPosition();this._clusterCenter=e,this._clusterBounds=this._calcBounds(e)}this._clusterMember.push(t)}},destroy:function(){naver.maps.Event.removeListener(this._relation);for(var t=this._clusterMember,e=0,s=t.length;e<s;e++)t[e].setMap(null);this._clusterMarker.setMap(null),this._clusterMarker=null,this._clusterCenter=null,this._clusterBounds=null,this._relation=null,this._clusterMember=[]},getCenter:function(){return this._clusterCenter},getBounds:function(){return this._clusterBounds},getCount:function(){return this._clusterMember.length},isInBounds:function(t){return this._clusterBounds&&this._clusterBounds.hasLatLng(t)},enableClickZoom:function(){if(!this._relation){var t=this._markerClusterer.getMap();this._relation=naver.maps.Event.addListener(this._clusterMarker,"click",function(e){t.morph(e.coord,t.getZoom()+1)})}},disableClickZoom:function(){this._relation&&(naver.maps.Event.removeListener(this._relation),this._relation=null)},updateCluster:function(){this._clusterMarker||(this._clusterMarker=new naver.maps.Marker({position:this._clusterCenter}),this._markerClusterer.getDisableClickZoom()||this.enableClickZoom()),this.updateIcon(),this.updateCount(),this.checkByZoomAndMinClusterSize()},checkByZoomAndMinClusterSize:function(){var t=this._markerClusterer,e=t.getMinClusterSize(),s=t.getMaxZoom(),r=t.getMap().getZoom();this.getCount()<e?this._showMember():(this._hideMember(),s<=r&&this._showMember())},updateCount:function(){var t=this._markerClusterer.getStylingFunction();t&&t(this._clusterMarker,this.getCount())},updateIcon:function(){var t=this.getCount(),e=this._getIndex(t),s=this._markerClusterer.getIcons();e=Math.max(e,0),e=Math.min(e,s.length-1),this._clusterMarker.setIcon(s[e])},_showMember:function(){for(var t=this._markerClusterer.getMap(),e=this._clusterMarker,s=this._clusterMember,r=0,n=s.length;r<n;r++)s[r].setMap(t);e&&e.setMap(null)},_hideMember:function(){for(var t=this._markerClusterer.getMap(),e=this._clusterMarker,s=this._clusterMember,r=0,n=s.length;r<n;r++)s[r].setMap(null);e&&e.setMap(t)},_calcBounds:function(t){var e=this._markerClusterer.getMap(),s=new naver.maps.LatLngBounds(t.clone(),t.clone()),r=e.getBounds(),n=e.getProjection(),i=n.fromCoordToOffset(r.getNE()),o=n.fromCoordToOffset(r.getSW()),a=n.fromCoordToOffset(s.getNE()),u=n.fromCoordToOffset(s.getSW()),l=this._markerClusterer.getGridSize()/2;a.add(l,-l),u.add(-l,l);var c=Math.min(i.x,a.x),h=Math.max(i.y,a.y),m=Math.max(o.x,u.x),_=Math.min(o.y,u.y),f=n.fromOffsetToCoord(new naver.maps.Point(c,h)),d=n.fromOffsetToCoord(new naver.maps.Point(m,_));return new naver.maps.LatLngBounds(d,f)},_getIndex:function(t){var e=this._markerClusterer.getIndexGenerator();if(naver.maps.Util.isFunction(e))return e(t);if(naver.maps.Util.isArray(e)){for(var s=0,r=s,n=e.length;r<n;r++){if(t<e[r])break;s++}return s}},_isMember:function(t){return-1!==this._clusterMember.indexOf(t)}};
